<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/html">
<meta charset="UTF-8">

<link rel="stylesheet" href="main.css">
<script src="main.js"></script>

<!-- Blockly라이브러리 사용을 위해 추가 -->
<script src="blockly/blockly_compressed.js"></script>
<script src="blockly/blocks_compressed.js"></script>
<script src="blockly/msg/ko.js"></script>


<!-- alert() 함수를 꾸미기 위해 추가한 스위트알럿 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- websocket 통신을 위해 추가-->
<script src="/webjars/jquery/jquery.min.js"></script>
<script src="/webjars/sockjs-client/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/stomp.min.js"></script>
<script src="collaborate.js"></script>

<body>

<div id="overlay">
    <div id="login-box">
        <h2 id="auth-title">로그인을 해주세요.</h2>
        <input type="text" id="id-input" placeholder="아이디">
        <input type="text" id="pw-input" placeholder="비밀번호">
        <div class="button-container">
            <button id="join-button">회원가입</button>
            <button id="login-button">로그인</button>
        </div>
    </div>
</div>


<div id="toast" class="toast">
    <span id="toastMessage"></span>
</div>

<div class="container">
        <div id="blocklyDiv" class="blocklyDivWrapper" ></div>
    <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
        <category name="시작" colour="#5ba55b">
            <block type="start"></block>
        </category>
        <category name="이미지 인식" colour="#5b67a5">
            <block type="learning_image_ai"></block>
            <block type="classify_by_trained_model_image"></block>
            <block type="turn_on_the_video"></block>
            <block type="when_detecting_image"></block>
            <block type="classification_result_image"></block>
            <block type="of_confidence_image"></block>
            <block type="class_learned_image"></block>
        </category>
        <category name="음성 인식" colour="#995ba5">
            <block type="learning_voice_ai"></block>
            <block type="classify_by_trained_model_voice"></block>
            <block type="turn_on_the_voice"></block>
            <block type="when_detecting_voice"></block>
            <block type="classification_result_voice"></block>
            <block type="of_confidence_voice"></block>
            <block type="class_learned_voice"></block>
        </category>
        <category name="텍스트 인식" colour="#5ba58c">
            <block type="learning_text_ai"></block>
            <block type="classify_by_trained_model_text"></block>
            <block type="turn_on_the_text"></block>
            <block type="when_detecting_text"></block>
            <block type="classification_result_text"></block>
            <block type="of_confidence_text"></block>
            <block type="class_learned_text"></block>
        </category>
        <category name="흐름" colour="#9fa55b">
            <block type="controls_if"></block>
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="controls_whileUntil">
                <field name="MODE">WHILE</field>
            </block>
        </category>
        <category name="연산" colour="#a5745b">
            <block type="math_number">
                <field name="NUM">0</field>
            </block>
            <block type="logic_compare">
                <field name="OP">EQ</field>
            </block>
            <block type="combine_letters"></block>
        </category>
        <category name="출력" colour="#a5745b">
            <block type="print"></block>
            <block type="show_results_together"></block>
            <block type="show_results_in_order"></block>
        </category>
    </xml>

        <div class="chat_wrap">
            <div class="header">
                <button id="invite-button">초대 링크 보기</button>
            </div>
            <div class="chat">
                <ul>
                    <!-- 동적 생성 -->
                </ul>
            </div>
            <div class="input-div">
                <textarea placeholder="Press Enter for send message."></textarea>
            </div>

            <!-- format -->

            <div class="chat format">
                <ul>
                    <li>
                        <div class="sender">
                            <span></span>
                        </div>
                        <div class="message">
                            <span></span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
</div>

<script>

    var workspace = Blockly.inject('blocklyDiv',
        { toolbox: document.getElementById('toolbox') });

</script>


<script>

    const joinButton = document.getElementById('join-button');
    const authTitle = document.getElementById('auth-title');
    const loginButton = document.getElementById('login-button');
    let isSignUp = false;
    let userId
    let urlParams = new URLSearchParams(window.location.search);
    let invitationParam = urlParams.get('invitation');

    const isRedirection = localStorage.getItem("isRedirection");
    //URL에 isRedirection이 있으면 웹소켓에 연결만 하고 로그인창을 띄우지 않음
    if(isRedirection){
        document.getElementById('overlay').style.display = 'none';
        // 로그인된 사용자의 userId 가져오기
        const userId = localStorage.getItem("userId");
        connect(userId, invitationParam);
        // 이제 isRedirection 값을 로컬 스토리지에서 삭제합니다.
        localStorage.removeItem("isRedirection");
    }

    joinButton.addEventListener('click', () => {
        isSignUp = !isSignUp;
        if (isSignUp) {
            authTitle.textContent = '회원가입을 해주세요.';
            loginButton.textContent = '회원가입 완료';
            joinButton.textContent = '로그인 화면';
        } else {
            authTitle.textContent = '로그인을 해주세요.';
            loginButton.textContent = '로그인';
            joinButton.textContent = '회원가입';
        }
    });

    loginButton.addEventListener('click', () => {
        if (isSignUp) {
            // 회원가입 처리 코드를 여기에 작성하세요.
            var userId = document.getElementById("id-input").value;
            var password = document.getElementById("pw-input").value;

            signUp(userId, password)
                .then(function(response) {
                    if (response.ok) {
                        // 회원가입 성공
                        console.log("회원가입 성공");

                        document.getElementById('overlay').style.display = 'none';

                        showToast("회원가입 성공!", 2000);

                    } else {
                        // 회원가입 실패
                        console.log("회원가입 실패");
                    }
                });
        } else {
            // 로그인 처리 코드를 여기에 작성하세요.
            var userId = document.getElementById("id-input").value;
            var password = document.getElementById("pw-input").value;
            showToast("로그인시도 성공!", 1000);
            login(userId, password)
                .then(async function(response) {
                    if (response.ok) {

                        // 처리 완료 후 창을 닫습니다.
                        document.getElementById('overlay').style.display = 'none';

                        showToast("로그인 성공!", 1000);

                        const updateResponse = await updateUserInvitationLink(userId, invitationParam );

                        if (updateResponse.ok) {
                            console.log("User invitation link updated successfully.");
                            connect(userId, invitationParam);

                            showToast("커넥션 시도", 2000);
                        } else {
                            console.error("Failed to update user invitation link.");
                        }
                    } else {
                        // 로그인 실패
                        showToast("아이디와 비밀번호를 다시 확인해주십시오", 2000);
                    }
                });
        }

    });

    // 초대 링크 보기 버튼
    document.getElementById('invite-button').addEventListener('click', () => {
        Swal.fire({
            title: '초대 링크',
            text: window.location.href,
            confirmButtonText: '확인'
        });
    });



</script>

</body>
</html>